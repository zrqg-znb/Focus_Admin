# 系统架构

## 整体架构

Focus Admin 采用前后端分离的架构设计，整体架构如下：

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│   浏览器 / 移动端 / 其他客户端                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Nginx 网关                             │
│   静态资源服务 / 反向代理 / 负载均衡                          │
└─────────────────────────────────────────────────────────────┘
                    │                     │
                    ▼                     ▼
┌─────────────────────────┐   ┌─────────────────────────────┐
│      前端应用            │   │         后端 API            │
│  Vue 3 + Element Plus   │   │   Django + Django Ninja     │
│       web-ele           │   │       backend-django        │
└─────────────────────────┘   └─────────────────────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
            ┌───────────┐         ┌───────────┐         ┌───────────┐
            │   MySQL   │         │   Redis   │         │   文件存储  │
            │  数据持久化 │         │  缓存/队列 │         │   本地/OSS │
            └───────────┘         └───────────┘         └───────────┘
                                          │
                                          ▼
                                  ┌───────────────┐
                                  │  外部数据源    │
                                  │ (API/数据中台) │
                                  └───────────────┘
```

## 后端模块架构

### 模块全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Django Application                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                           Core (核心模块)                              │ │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│   │  │  Auth   │ │  User   │ │  Role   │ │  Menu   │ │  Dept   │  ...   │ │
│   │  │  认证    │ │  用户    │ │  角色    │ │  菜单    │ │  部门    │        │ │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                           Apps (业务模块)                              │ │
│   │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│   │  │                     project_manager (项目管理)                   │ │ │
│   │  │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │ │
│   │  │   │ Project │ │Milestone│ │Iteration│ │CodeQual │ │   DTS   │ │ │ │
│   │  │   │  项目    │ │ 里程碑  │ │  迭代    │ │代码质量 │ │ 问题单  │ │ │ │
│   │  │   └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ │ │ │
│   │  └─────────────────────────────────────────────────────────────────┘ │ │
│   │                                                                       │ │
│   │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐            │ │
│   │  │Performance│ │CodeCompli │ │ Delivery  │ │Integration│     ...    │ │
│   │  │  绩效管理  │ │  代码合规  │ │ 交付矩阵  │ │  集成报告  │            │ │
│   │  └───────────┘ └───────────┘ └───────────┘ └───────────┘            │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                         Common (公共模块)                              │ │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │ │
│   │  │fu_model │ │fu_crud  │ │fu_schema│ │ fu_auth │ │  utils  │  ...   │ │
│   │  │模型基类  │ │CRUD基类 │ │Schema类 │ │认证装饰器│ │ 工具函数 │        │ │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘        │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                        Scheduler (调度模块)                            │ │
│   │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│   │  │  定时任务  │  数据同步  │  报告生成  │  通知推送  │  ...         │ │ │
│   │  └─────────────────────────────────────────────────────────────────┘ │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 核心模块与业务模块关系

```
                    ┌─────────────────────────────────────┐
                    │            Core 核心模块             │
                    │  (User, Role, Permission, Menu...)  │
                    └─────────────────────────────────────┘
                                      │
                            用户、权限、组织架构
                                      │
         ┌────────────────────────────┼────────────────────────────┐
         │                            │                            │
         ▼                            ▼                            ▼
┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
│  project_manager │        │   performance   │        │  code_compliance │
│    项目管理       │        │    绩效管理      │        │    代码合规       │
│                  │        │                 │        │                  │
│ - Project        │        │ - Indicator     │        │ - Rule           │
│ - Milestone      │◀──────▶│ - Record        │        │ - CheckResult    │
│ - Iteration      │        │ - Statistics    │        │ - Report         │
│ - CodeQuality    │        │                 │        │                  │
│ - DTS            │        │                 │        │                  │
└─────────────────┘        └─────────────────┘        └─────────────────┘
         │                            │                            │
         └────────────────────────────┼────────────────────────────┘
                                      │
                                      ▼
                         ┌─────────────────────┐
                         │   Scheduler 调度    │
                         │  (定时任务、数据同步) │
                         └─────────────────────┘
```

### 分层设计

```
┌─────────────────────────────────────────────────────────────┐
│                      API 层 (Router)                        │
│           接收请求、参数验证、调用 Service                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   服务层 (Service)                           │
│              业务逻辑处理、事务管理                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    模型层 (Model)                            │
│              数据模型定义、ORM 操作                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (Database)                         │
│                MySQL + Redis 数据存储                        │
└─────────────────────────────────────────────────────────────┘
```

### 模块划分

```
backend-django/
├── application/              # 应用配置层
│   ├── settings.py          # Django 配置
│   ├── urls.py              # URL 总路由
│   └── main.py              # Django Ninja API 注册
│
├── core/                     # 核心模块
│   ├── auth/                # 认证
│   ├── user/                # 用户
│   ├── role/                # 角色
│   ├── permission/          # 权限
│   ├── menu/                # 菜单
│   ├── dept/                # 部门
│   └── ...
│
├── apps/                     # 业务模块
│   ├── project_manager/     # 项目管理
│   ├── performance/         # 绩效管理
│   ├── code_compliance/     # 代码合规
│   └── ...
│
├── common/                   # 公共模块
│   ├── fu_crud.py           # CRUD 基类
│   ├── fu_model.py          # Model 基类
│   ├── fu_schema.py         # Schema 基类
│   └── fu_auth.py           # 认证装饰器
│
└── scheduler/                # 调度模块
    ├── service.py           # 调度服务
    └── tasks.py             # 任务定义
```

## 前端架构

### Monorepo 结构

```
web/
├── apps/                     # 应用层
│   └── web-ele/             # Element Plus 版本应用
│       └── src/
│           ├── api/         # API 请求封装
│           ├── components/  # 业务组件
│           ├── router/      # 路由配置
│           ├── store/       # Pinia Store
│           └── views/       # 页面视图
│
├── packages/                 # 共享包层
│   ├── @core/               # 核心包
│   │   ├── base/            # 基础组件
│   │   ├── composables/     # 组合式函数
│   │   └── preferences/     # 偏好设置
│   │
│   ├── effects/             # 副作用
│   ├── icons/               # 图标
│   ├── locales/             # 国际化
│   ├── stores/              # 共享状态
│   ├── styles/              # 样式
│   └── utils/               # 工具
│
└── internal/                 # 内部工具
    ├── lint-configs/        # Lint 配置
    ├── vite-config/         # Vite 配置
    └── tsconfig/            # TS 配置
```

### 数据流

```
┌──────────┐    dispatch    ┌──────────┐    request    ┌──────────┐
│   View   │ ──────────────▶│   Store  │ ─────────────▶│   API    │
│  (组件)   │                │ (Pinia)  │               │ (请求层)  │
└──────────┘                └──────────┘               └──────────┘
     ▲                           │                          │
     │                           │                          │
     │         state             │        response          │
     └───────────────────────────┴──────────────────────────┘
```

## 认证流程

```
┌──────────┐                 ┌──────────┐                 ┌──────────┐
│  客户端   │                 │  后端API  │                 │  数据库   │
└────┬─────┘                 └────┬─────┘                 └────┬─────┘
     │                            │                            │
     │   1. 登录请求 (用户名/密码)  │                            │
     │ ──────────────────────────▶│                            │
     │                            │   2. 验证用户               │
     │                            │ ──────────────────────────▶│
     │                            │                            │
     │                            │   3. 返回用户信息           │
     │                            │◀────────────────────────── │
     │                            │                            │
     │   4. 返回 JWT Token        │                            │
     │◀────────────────────────── │                            │
     │                            │                            │
     │   5. 携带 Token 请求        │                            │
     │ ──────────────────────────▶│                            │
     │                            │   6. 验证 Token & 权限      │
     │                            │ ──────────────────────────▶│
     │                            │                            │
     │   7. 返回业务数据           │                            │
     │◀────────────────────────── │                            │
     │                            │                            │
```

## 部署架构

### 单机部署

适用于开发环境和小型应用：

```
┌─────────────────────────────────────────┐
│               单台服务器                 │
│  ┌─────────────────────────────────┐   │
│  │            Nginx               │   │
│  │   - 静态资源 (前端 dist)        │   │
│  │   - 反向代理 (/api -> Django)  │   │
│  └─────────────────────────────────┘   │
│                   │                     │
│                   ▼                     │
│  ┌─────────────────────────────────┐   │
│  │       Django (Gunicorn)         │   │
│  └─────────────────────────────────┘   │
│            │              │             │
│            ▼              ▼             │
│      ┌─────────┐    ┌─────────┐        │
│      │  MySQL  │    │  Redis  │        │
│      └─────────┘    └─────────┘        │
└─────────────────────────────────────────┘
```

### 容器化部署

使用 Docker Compose：

```yaml
services:
  nginx:      # 前端 + 反向代理
  backend:    # Django 应用
  mysql:      # 数据库
  redis:      # 缓存
```

## 数据同步架构

系统支持从外部数据源同步数据，采用异步任务 + 日志记录的方式：

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│   APScheduler    │      │   Sync Service  │      │   External API  │
│   定时触发器       │────▶│   同步服务       │────▶│   外部数据源     │
└─────────────────┘      └───────┬─────────┘      └─────────────────┘
                               │
                    ┌─────────┼─────────┐
                    │         │         │
                    ▼         ▼         ▼
              ┌─────────┐ ┌─────────┐ ┌─────────┐
              │ SyncLog │ │ Metric  │ │ Business│
              │ 同步日志  │ │ 指标数据  │ │ 业务数据  │
              └─────────┘ └─────────┘ └─────────┘
                    │         │         │
                    └─────────┼─────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │     MySQL       │
                    │   数据持久化       │
                    └─────────────────┘
```

**同步类型：**

| 同步类型 | 说明 | 数据具象 |
| --- | --- | --- |
| iteration | 迭代数据 | SR/DR/AR 需求数、状态分布 |
| dts | DTS问题单 | DI值、解决率、等级分布 |
| code_quality | 代码质量 | LOC、函数数、重复率 |
| milestone | 里程碑 | QG点日期、风险项 |
| project | 项目信息 | 项目基础信息 |

## API 请求流程

```
┌───────────┐
│  Request  │
└─────┬─────┘
      │
      ▼
┌───────────────────────────────────────────────┐
│ Middleware: JWT 认证 → 权限校验 → 日志记录 │
└───────────────────────┬───────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────┐
│           Router (Django Ninja)             │
│     路由匹配 → Schema 验证 → 参数解析         │
└───────────────────────┬───────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────┐
│                  Service                     │
│        业务逻辑 → 事务处理 → 数据操作           │
└───────────────────────┬───────────────────────┘
                        │
         ┌─────────────┼─────────────┐
         │             │             │
         ▼             ▼             ▼
   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │  Model  │   │  Cache  │   │  File   │
   │  (ORM)  │   │ (Redis) │   │ Storage │
   └─────────┘   └─────────┘   └─────────┘
         │             │             │
         ▼             ▼             ▼
   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │  MySQL  │   │  Redis  │   │  Disk   │
   └─────────┘   └─────────┘   └─────────┘
```

## 模块通信机制

后端模块间的通信采用直接调用 + 事件通知的方式：

```
┌───────────────┐          ┌───────────────┐
│  Module A     │          │  Module B     │
│  (e.g. User)  │          │ (e.g.Project) │
└───────┬───────┘          └───────┬───────┘
        │                            │
        │  1. 直接导入调用              │
        ├───────────────────────────▶│
        │                            │
        │  2. 通过 ForeignKey 关联    │
        ├───────────────────────────▶│
        │                            │
        │  3. 通过 Service 层调用     │
        └───────────────────────────▶│
```

**典型场景：**

1. **项目关联用户**：Project.managers 通过 ManyToMany 关联 User
2. **迭代引用项目**：Iteration.project 通过 ForeignKey 关联 Project
3. **服务层跨模块调用**：ReportService 调用 IterationService 获取迭代数据
