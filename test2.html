<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>项目生命周期管理驾驶舱</title>

  <!-- 引入 DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

  <!-- 内部 CSS 样式 -->
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f4f7f9;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    #gantt-chart {
      width: 100%;
      height: 450px;
      margin-top: 20px;
    }
    #project-table {
      width: 100%;
      margin-top: 30px;
    }
    .filters {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #ecf0f1;
      border-radius: 5px;
    }
    .filters label {
      margin-right: 10px;
      font-weight: bold;
    }
    .filters select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* QG 状态样式 */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      color: #fff;
      font-size: 0.8em;
      text-align: center;
      display: inline-block;
      min-width: 80px;
    }
    .status-completed { background-color: #2ecc71; }
    .status-delayed_completed { background-color: #f39c12; }
    .status-in_progress { background-color: #3498db; }
    .status-at_risk { background-color: #e74c3c; }
    .status-not_started { background-color: #bdc3c7; }
    .status-blocked { background-color: #34495e; }
  </style>
</head>
<body>

<div class="container">
  <h1>项目生命周期管理驾驶舱</h1>

  <!-- 筛选区域 -->
  <div class="filters">
    <label for="pm-filter">项目经理:</label>
    <select id="pm-filter">
      <option value="">全部</option>
    </select>
  </div>

  <!-- ECharts 甘特图容器 -->
  <div id="gantt-chart"></div>

  <!-- DataTable 表格容器 -->
  <table id="project-table" class="display compact">
    <thead>
    <tr>
      <th>项目名称</th>
      <th>项目经理</th>
      <th>整体状态</th>
      <th>Charter</th>
      <th>QG1</th>
      <th>QG2</th>
      <th>QG3</th>
      <th>QG4</th>
      <th>QG5</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 引入 JS 库 -->
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script> <!-- Day.js 用于日期处理 -->


<script>
  $(document).ready(function() {

    // 1. 模拟的后端数据
    const projectData = [
      {
        "projectId": "PROJ-001", "projectName": "新一代CRM系统", "projectManager": "张三", "overallStatus": "at_risk",
        "gates": [
          { "name": "Charter", "planDate": "2025-01-20", "actualDate": "2025-01-18", "status": "completed" },
          { "name": "QG1", "planDate": "2025-02-28", "actualDate": "2025-03-02", "status": "delayed_completed" },
          { "name": "QG2", "planDate": "2025-04-15", "actualDate": "2025-04-15", "status": "completed" },
          { "name": "QG3", "planDate": "2025-06-10", "actualDate": null, "status": "at_risk" },
          { "name": "QG4", "planDate": "2025-08-05", "actualDate": null, "status": "not_started" },
          { "name": "QG5", "planDate": "2025-09-20", "actualDate": null, "status": "not_started" }
        ]
      },
      {
        "projectId": "PROJ-002", "projectName": "财务数据中台", "projectManager": "李四", "overallStatus": "normal",
        "gates": [
          { "name": "Charter", "planDate": "2025-03-15", "actualDate": "2025-03-14", "status": "completed" },
          { "name": "QG1", "planDate": "2025-05-10", "actualDate": "2025-05-10", "status": "completed" },
          { "name": "QG2", "planDate": "2025-07-01", "actualDate": null, "status": "in_progress" },
          { "name": "QG3", "planDate": "2025-09-10", "actualDate": null, "status": "not_started" },
          { "name": "QG4", "planDate": "2025-11-05", "actualDate": null, "status": "not_started" },
          { "name": "QG5", "planDate": "2025-12-28", "actualDate": null, "status": "not_started" }
        ]
      },
      {
        "projectId": "PROJ-003", "projectName": "移动端APP重构", "projectManager": "王五", "overallStatus": "completed",
        "gates": [
          { "name": "Charter", "planDate": "2025-02-01", "actualDate": "2025-02-01", "status": "completed" },
          { "name": "QG1", "planDate": "2025-03-20", "actualDate": "2025-03-19", "status": "completed" },
          { "name": "QG2", "planDate": "2025-05-15", "actualDate": "2025-05-20", "status": "delayed_completed" },
          { "name": "QG3", "planDate": "2025-07-10", "actualDate": "2025-07-09", "status": "completed" },
          { "name": "QG4", "planDate": "2025-08-30", "actualDate": "2025-08-30", "status": "completed" },
          { "name": "QG5", "planDate": "2025-10-15", "actualDate": "2025-10-14", "status": "completed" }
        ]
      },
      {
        "projectId": "PROJ-004", "projectName": "智慧物流平台", "projectManager": "张三", "overallStatus": "delayed",
        "gates": [
          { "name": "Charter", "planDate": "2025-04-10", "actualDate": "2025-04-15", "status": "delayed_completed" },
          { "name": "QG1", "planDate": "2025-06-01", "actualDate": "2025-06-10", "status": "delayed_completed" },
          { "name": "QG2", "planDate": "2025-08-01", "actualDate": null, "status": "at_risk" },
          { "name": "QG3", "planDate": "2025-10-01", "actualDate": null, "status": "not_started" },
          { "name": "QG4", "planDate": "2025-12-01", "actualDate": null, "status": "not_started" },
          { "name": "QG5", "planDate": "2026-01-20", "actualDate": null, "status": "not_started" }
        ]
      }
    ];

    const statusMap = {
      'completed': '已完成',
      'delayed_completed': '延期完成',
      'in_progress': '进行中',
      'at_risk': '有风险',
      'not_started': '未开始',
      'blocked': '受阻'
    };

    // 2. 初始化 DataTable
    const gateNames = ["Charter", "QG1", "QG2", "QG3", "QG4", "QG5"];

    function renderGateCell(data, type, row) {
      const gate = row.gates.find(g => g.name === data);
      if (gate) {
        const dateStr = gate.actualDate ? ` (${dayjs(gate.actualDate).format('MM-DD')})` : ` (${dayjs(gate.planDate).format('MM-DD')})`;
        return `<span class="status-badge status-${gate.status}">${statusMap[gate.status]}${dateStr}</span>`;
      }
      return '';
    }

    const tableColumns = [
      { data: 'projectName', title: '项目名称' },
      { data: 'projectManager', title: '项目经理' },
      {
        data: 'overallStatus',
        title: '整体状态',
        render: function(data, type, row) {
          return `<span class="status-badge status-${data === 'normal' ? 'in_progress' : data}">${data}</span>`;
        }
      }
    ];

    gateNames.forEach(name => {
      tableColumns.push({
        data: () => name, // Pass the name to the render function
        title: name,
        render: renderGateCell
      });
    });

    const table = $('#project-table').DataTable({
      data: projectData,
      columns: tableColumns,
      language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-Hans.json" }
    });

    // 3. 初始化筛选器
    const pmSet = new Set(projectData.map(p => p.projectManager));
    pmSet.forEach(pm => {
      $('#pm-filter').append(new Option(pm, pm));
    });

    $('#pm-filter').on('change', function() {
      // 'projectManager' is the second column (index 1)
      table.column(1).search(this.value).draw();
    });


    // 4. 初始化 ECharts 甘特图
    const ganttChart = echarts.init(document.getElementById('gantt-chart'));

    // 数据转换：将 projectData 转换为 ECharts 需要的格式
    const projectNames = projectData.map(p => p.projectName);
    const planSeriesData = [];
    const progressSeriesData = [];
    const qgPointsData = [];

    projectData.forEach((p, index) => {
      const gateDates = p.gates.map(g => dayjs(g.planDate).valueOf());
      const start = Math.min(...gateDates);
      const end = Math.max(...gateDates);

      // 计划周期数据
      planSeriesData.push({
        name: p.projectName,
        value: [index, start, end, p.projectName]
      });

      // 实际进度数据
      const completedGates = p.gates.filter(g => g.status === 'completed' || g.status === 'delayed_completed').length;
      const progress = p.gates.length > 0 ? completedGates / p.gates.length : 0;
      const actualEndDate = start + (end - start) * progress;

      progressSeriesData.push({
        name: p.projectName,
        value: [index, start, actualEndDate, progress],
        itemStyle: {
          normal: { color: p.overallStatus === 'at_risk' ? '#e74c3c' : '#2ecc71' }
        }
      });

      // QG节点散点数据
      p.gates.forEach(g => {
        if (g.actualDate) {
          qgPointsData.push({
            name: g.name,
            value: [index, dayjs(g.actualDate).valueOf()],
            itemStyle: {
              color: g.status === 'completed' ? '#27ae60' : '#f39c12'
            }
          });
        }
      });
    });

    // ECharts 配置
    const ganttOption = {
      title: {
        text: '项目进度甘特图',
        left: 'center'
      },
      tooltip: {
        trigger: 'item',
        formatter: function (params) {
          if (params.seriesType === 'custom') {
            // 进度条提示
            const progressPercent = (params.value[3] * 100).toFixed(0);
            return `${params.value[2]}<br/>进度: ${progressPercent}%`;
          } else if (params.seriesType === 'scatter') {
            // QG节点提示
            return `${params.marker} ${params.seriesName}: ${params.name}<br/>完成日期: ${dayjs(params.value[1]).format('YYYY-MM-DD')}`;
          }
          return '';
        }
      },
      grid: {
        left: '150px',
        right: '4%',
        bottom: '10%',
        containLabel: false
      },
      xAxis: {
        type: 'time',
        axisLabel: {
          formatter: '{yyyy}-{MM}'
        }
      },
      yAxis: {
        type: 'category',
        data: projectNames,
        axisLabel: {
          interval: 0
        }
      },
      series: [
        // 系列1: 灰色背景条 (计划周期)
        {
          type: 'custom',
          renderItem: function (params, api) {
            let categoryIndex = api.value(0);
            let start = api.coord([api.value(1), categoryIndex]);
            let end = api.coord([api.value(2), categoryIndex]);
            let height = api.size([0, 1])[1] * 0.4;
            return {
              type: 'rect',
              shape: { x: start[0], y: start[1] - height / 2, width: end[0] - start[0], height: height },
              style: { fill: '#ecf0f1' }
            };
          },
          itemStyle: {
            opacity: 0.8
          },
          encode: { x: [1, 2], y: 0 },
          data: planSeriesData
        },
        // 系列2: 彩色进度条 (实际进度)
        {
          type: 'custom',
          renderItem: function (params, api) {
            let categoryIndex = api.value(0);
            let start = api.coord([api.value(1), categoryIndex]);
            let end = api.coord([api.value(2), categoryIndex]);
            let height = api.size([0, 1])[1] * 0.4;
            return {
              type: 'rect',
              shape: { x: start[0], y: start[1] - height / 2, width: end[0] - start[0], height: height },
              style: api.style()
            };
          },
          encode: { x: [1, 2], y: 0 },
          data: progressSeriesData
        },
        // 系列3: 已完成的QG节点
        {
          name: '完成节点',
          type: 'scatter',
          symbolSize: 10,
          data: qgPointsData,
          encode: {
            x: 1, // x轴使用value数组的第1个元素
            y: 0  // y轴使用value数组的第0个元素
          }
        },
        // 系列4: 标记线：今天
        {
          name: '今天',
          type: 'line',
          markLine: {
            silent: true,
            symbol: 'none',
            lineStyle: {
              color: '#c0392b',
              type: 'solid',
              width: 2
            },
            label: {
              formatter: '今天',
              position: 'start'
            },
            data: [{ xAxis: new Date() }]
          }
        }
      ]
    };

    ganttChart.setOption(ganttOption);

    // ECharts图表自适应窗口大小变化
    window.addEventListener('resize', function() {
      ganttChart.resize();
    });
  });
</script>

</body>
</html>
